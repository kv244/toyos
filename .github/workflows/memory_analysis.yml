name: Memory Analysis

on: [push, pull_request]

jobs:
  analyze_ram:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Arduino CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Install ARM Core
      run: |
        arduino-cli core update-index
        arduino-cli core install arduino:renesas_uno

    - name: Compile and Generate Map File
      run: |
        mkdir -p build_output
        arduino-cli compile --fqbn arduino:renesas_uno:unor4wifi \
          --build-property "compiler.c.elf.extra_flags=-Wl,-Map=build_output/output.map" \
          --output-dir build_output \
          --libraries libraries \
          app/kv_db_demo

    - name: Locate Toolchain
      id: toolchain
      run: |
        # Find where the ARM toolchain binary is located
        # We look for the 'bin' directory containing arm-none-eabi-gcc
        BINARY_PATH=$(find $HOME/.arduino15/packages/arduino/tools -type f -name "arm-none-eabi-size" | head -n 1)
        if [ -z "$BINARY_PATH" ]; then
          echo "Toolchain not found! Listing tools directory:"
          find $HOME/.arduino15/packages/arduino/tools -maxdepth 4
          exit 1
        fi
        TOOLCHAIN_DIR=$(dirname "$BINARY_PATH")
        echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
        echo "Found toolchain at: $TOOLCHAIN_DIR"

    - name: Run Size Analysis
      run: |
        "$TOOLCHAIN_DIR/arm-none-eabi-size" build_output/kv_db_demo.ino.elf

    - name: Top RAM Consumers (arm-none-eabi-nm)
      run: |
        echo "Symbol Analysis (Top 20 RAM Consumers):"
        echo "SIZE TYPE NAME"
        "$TOOLCHAIN_DIR/arm-none-eabi-nm" -C --size-sort -r -S -t d build_output/kv_db_demo.ino.elf | grep -E " [dDbB] " | head -n 20

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: memory-report
        path: |
          build_output/output.map
          build_output/kv_db_demo.ino.elf
